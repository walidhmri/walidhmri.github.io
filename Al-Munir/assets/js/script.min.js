const API_BASE="https://api.alquran.cloud/v1";let currentSurah="selectSurah",currentAyah=null,currentEdition="selectTafsir",currentAudioEdition="selectAudio",autoplayEnabled=!1,loopEnabled=!1,rangeModeEnabled=!1,rangeStart=1,rangeEnd=1,totalAyahs=1,originalArabicText="";const elements={surahSelect:document.getElementById("surahSelect"),editionSelect:document.getElementById("editionSelect"),audioEditionSelect:document.getElementById("audioEditionSelect"),loading:document.getElementById("loading"),error:document.getElementById("error"),arabicText:document.getElementById("arabicText"),translationText:document.getElementById("translationText"),surahInfo:document.getElementById("surahInfo"),ayahInfo:document.getElementById("ayahInfo"),quranAudio:document.getElementById("quranAudio"),prevAyah:document.getElementById("prevAyah"),nextAyah:document.getElementById("nextAyah"),toggleAutoplay:document.getElementById("toggleAutoplay"),toggleLoop:document.getElementById("toggleLoop"),toggleRangeMode:document.getElementById("toggleRangeMode"),rangeControls:document.getElementById("rangeControls"),rangeStart:document.getElementById("rangeStart"),rangeEnd:document.getElementById("rangeEnd"),setRange:document.getElementById("setRange"),playbackControls:document.querySelector(".playback-controls"),quranContent:document.getElementById("quranContent")};function updateToggleButton(e,t,a){e.textContent=`${t}: ${a?"On":"Off"}`,e.classList.toggle("active",a)}function showLoading(e){elements.loading.style.display=e?"block":"none",e&&(elements.error.style.display="none")}function showError(e){elements.error.textContent=e,elements.error.style.display="block",elements.loading.style.display="none"}async function fetchApi(e){try{let t=await fetch(`https://api.alquran.cloud/v1${e}`);if(!t.ok)throw Error("Network response was not ok");return await t.json()}catch(a){throw showError(a.message),a}}async function loadEditions(){showLoading(!0);try{let[e,t]=await Promise.all([fetchApi("/edition?format=text"),fetchApi("/edition?format=audio&type=versebyverse"),]);e.data.forEach(e=>{let t=new Option(e.name,e.identifier);elements.editionSelect.add(t)}),t.data.forEach(e=>{let t=new Option(e.name,e.identifier);elements.audioEditionSelect.add(t)})}catch(a){showError("خطأ في تحميل البيانات")}showLoading(!1)}async function loadSurahs(){showLoading(!0);try{let e=await fetchApi("/surah");e.data.forEach(e=>{let t=new Option(`${e.number}. ${e.englishName} (${e.name})`,e.number);elements.surahSelect.add(t)})}catch(t){showError("خطأ في تحميل السورة")}showLoading(!1)}async function loadAyah(e,t,a=currentEdition){showLoading(!0);try{let n=await fetchApi(`/ayah/${e}:${t}/quran-uthmani`),r=n.data;originalArabicText=r.text;let l="",o="";if(a&&"quran-uthmani"!==a&&"selectTafsir"!==a){let d=await fetchApi(`/ayah/${e}:${t}/${a}`);l=d.data.text,o=d.data.edition.name}if(elements.arabicText.innerHTML=`
            <div class="verse-container">
              <div class="arabic">${originalArabicText}</div>
              ${l?`<div class="edition-label">${o}</div>
                     <div class="translation">${l}</div>`:""}
            </div>
          `,elements.surahInfo.textContent=`Surah ${r.surah.englishName} (${r.surah.name})`,elements.ayahInfo.textContent=`Ayah ${r.numberInSurah} of ${r.surah.numberOfAyahs}`,totalAyahs=r.surah.numberOfAyahs,elements.rangeEnd.max=totalAyahs,currentAudioEdition&&"selectAudio"!==currentAudioEdition){let i=await fetchApi(`/ayah/${e}:${t}/${currentAudioEdition}`);elements.quranAudio.src=i.data.audio,autoplayEnabled&&elements.quranAudio.play()}updateNavigationButtons(r.numberInSurah,r.surah.numberOfAyahs),currentSurah=e,currentAyah=t,saveState()}catch(s){showError("خطأ في تحميل الأية")}showLoading(!1)}function updateNavigationButtons(e,t){rangeModeEnabled?(elements.prevAyah.disabled=e<=rangeStart,elements.nextAyah.disabled=e>=rangeEnd):(elements.prevAyah.disabled=1===e,elements.nextAyah.disabled=e===t)}function updateControlsVisibility(){let e="selectSurah"!==elements.surahSelect.value,t="selectAudio"!==elements.audioEditionSelect.value;elements.quranAudio.classList.toggle("hidden",!(e&&t)),elements.prevAyah.classList.toggle("hidden",!e),elements.nextAyah.classList.toggle("hidden",!e),elements.quranContent.classList.toggle("hidden",!e),elements.playbackControls.classList.toggle("hidden",!(e&&t))}function handleAudioEnd(){loopEnabled?elements.quranAudio.play():autoplayEnabled&&(rangeModeEnabled?currentAyah<rangeEnd?loadAyah(currentSurah,currentAyah+1):loopEnabled&&loadAyah(currentSurah,rangeStart):currentAyah<totalAyahs&&loadAyah(currentSurah,currentAyah+1))}function saveState(){let e={currentSurah,currentAyah,currentEdition,currentAudioEdition,autoplayEnabled,loopEnabled,rangeModeEnabled,rangeStart,rangeEnd,totalAyahs};localStorage.setItem("quranAppState",JSON.stringify(e))}function loadState(){let e=localStorage.getItem("quranAppState");if(e)try{let t=JSON.parse(e);currentSurah=t.currentSurah,currentAyah=t.currentAyah,currentEdition=t.currentEdition,currentAudioEdition=t.currentAudioEdition,autoplayEnabled=t.autoplayEnabled,loopEnabled=t.loopEnabled,rangeModeEnabled=t.rangeModeEnabled,rangeStart=t.rangeStart,rangeEnd=t.rangeEnd,totalAyahs=t.totalAyahs,elements.surahSelect.value=currentSurah,elements.editionSelect.value=currentEdition,elements.audioEditionSelect.value=currentAudioEdition,updateToggleButton(elements.toggleAutoplay,"التشغيل التلقائي للأيات",autoplayEnabled),updateToggleButton(elements.toggleLoop,"تكرار الأية الحالية",loopEnabled),updateToggleButton(elements.toggleRangeMode,"تحديد مجال الأيات",rangeModeEnabled),elements.rangeStart.value=rangeStart,elements.rangeEnd.value=rangeEnd,"selectSurah"!==currentSurah&&(elements.quranAudio.classList.remove("hidden"),elements.prevAyah.classList.remove("hidden"),elements.nextAyah.classList.remove("hidden"),elements.quranContent.classList.remove("hidden"),"selectAudio"!==currentAudioEdition&&elements.playbackControls.classList.remove("hidden")),elements.rangeControls.style.display=rangeModeEnabled?"flex":"none",currentSurah&&currentAyah&&loadAyah(currentSurah,currentAyah,currentEdition)}catch(a){showError("خطأ في تحميل البيانات المحفوظة")}updateControlsVisibility()}function initializeHiddenElements(){elements.quranAudio.classList.add("hidden"),elements.prevAyah.classList.add("hidden"),elements.nextAyah.classList.add("hidden"),elements.quranContent.classList.add("hidden"),elements.playbackControls.classList.add("hidden")}async function init(){initializeHiddenElements(),await Promise.all([loadSurahs(),loadEditions()]),loadState()}elements.quranAudio.addEventListener("ended",handleAudioEnd),elements.toggleAutoplay.addEventListener("click",()=>{autoplayEnabled=!autoplayEnabled,updateToggleButton(elements.toggleAutoplay,"التشغيل التلقائي للأيات",autoplayEnabled),saveState()}),elements.toggleLoop.addEventListener("click",()=>{loopEnabled=!loopEnabled,updateToggleButton(elements.toggleLoop,"تكرار الأية الحالية",loopEnabled),saveState()}),elements.toggleRangeMode.addEventListener("click",()=>{rangeModeEnabled=!rangeModeEnabled,updateToggleButton(elements.toggleRangeMode,"تحديد مجال الأيات",rangeModeEnabled),elements.rangeControls.style.display=rangeModeEnabled?"flex":"none",rangeModeEnabled&&(elements.rangeStart.value=currentAyah||1,elements.rangeEnd.value=totalAyahs,rangeStart=currentAyah||1,rangeEnd=totalAyahs),updateNavigationButtons(currentAyah||1,totalAyahs),saveState()}),elements.setRange.addEventListener("click",()=>{(rangeStart=parseInt(elements.rangeStart.value))>(rangeEnd=parseInt(elements.rangeEnd.value))&&([rangeStart,rangeEnd]=[rangeEnd,rangeStart],elements.rangeStart.value=rangeStart,elements.rangeEnd.value=rangeEnd),!currentAyah||currentAyah<rangeStart||currentAyah>rangeEnd?loadAyah(currentSurah,rangeStart):updateNavigationButtons(currentAyah,totalAyahs),saveState()}),elements.prevAyah.addEventListener("click",()=>{let e=rangeModeEnabled?rangeStart:1;currentAyah>e&&(loadAyah(currentSurah,currentAyah-1),saveState())}),elements.nextAyah.addEventListener("click",()=>{let e=rangeModeEnabled?rangeEnd:totalAyahs;currentAyah<e&&(loadAyah(currentSurah,currentAyah+1),saveState())}),elements.surahSelect.addEventListener("change",e=>{let t=e.target.value;t&&"selectSurah"!==t&&(loadAyah(currentSurah=parseInt(t),currentAyah=1),saveState(),updateControlsVisibility())}),elements.editionSelect.addEventListener("change",e=>{e.target.value&&(currentEdition=e.target.value,loadAyah(currentSurah,currentAyah),saveState())}),elements.audioEditionSelect.addEventListener("change",e=>{e.target.value&&(currentAudioEdition=e.target.value,loadAyah(currentSurah,currentAyah),saveState(),updateControlsVisibility())}),init();
